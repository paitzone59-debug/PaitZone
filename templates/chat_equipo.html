{% extends "base.html" %}

{% block content %}
<div class="chat-container">
    <!-- Header del Chat -->
    <div class="chat-header">
        <div class="header-content">
            <div class="chat-info">
                <div class="chat-avatar">
                    <i class="fas fa-users"></i>
                </div>
                <div class="chat-details">
                    <h3 class="chat-title">{{ equipo_nombre }}</h3>
                    <div class="chat-status">
                        <span class="status-dot online"></span>
                        <span class="status-text">Miembros activos</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">

                <a href="{{ url_for('mi_equipo') }}" class="back-btn">
                    <i class="fas fa-arrow-left"></i>
                    <span>Volver</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Área de Mensajes -->
    <div class="chat-messages" id="chatMessages">
        {% for mensaje in mensajes %}
        <div class="message {% if mensaje.usuario_id == usuario.id %}message-sent{% else %}message-received{% endif %}" 
             data-message-id="{{ mensaje.id }}">
            {% if mensaje.usuario_id != usuario.id %}
            <div class="message-avatar">
                <div class="avatar-circle">
                    {{ mensaje.nombre_completo[0]|upper }}
                </div>
            </div>
            {% endif %}
            
            <div class="message-content">
                {% if mensaje.usuario_id != usuario.id %}
                <div class="message-header">
                    <span class="sender-name">{{ mensaje.nombre_completo }}</span>
                    <span class="message-time">{{ mensaje.fecha.strftime('%H:%M') }}</span>
                </div>
                {% endif %}
                
                <div class="message-bubble">
                    <div class="message-text">{{ mensaje.mensaje }}</div>
                    {% if mensaje.usuario_id == usuario.id %}
                    <div class="message-status">
                        <span class="message-time">{{ mensaje.fecha.strftime('%H:%M') }}</span>
                        <i class="fas fa-check-double delivered"></i>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Input de Mensajes -->
    <div class="chat-input-container">
        <div class="input-wrapper">
            <!-- Botones de acción -->
            <div class="input-actions">
                <button class="action-btn emoji-toggle" id="emojiToggle" title="Emojis">
                    <i class="far fa-smile"></i>
                </button>
            </div>

            <!-- Input principal -->
            <form id="messageForm" class="message-form">
                <div class="input-group">
                    <input type="text" 
                           id="messageInput" 
                           class="message-input" 
                           placeholder="Escribe un mensaje..." 
                           autocomplete="off"
                           maxlength="1000">
                    
                    <!-- Contador de caracteres -->
                    <div class="char-counter" id="charCounter">
                        <span class="char-count">0</span>/1000
                    </div>
                </div>

                <!-- Botón de enviar -->
                <button type="submit" class="send-btn" id="sendBtn" title="Enviar mensaje">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </form>
        </div>

        <!-- Selector de Emojis Premium -->
        <div class="emoji-picker" id="emojiPicker">
            <div class="emoji-header">
                <div class="emoji-categories">
                    <button class="category-btn active" data-category="faces">
                        <i class="far fa-smile"></i>
                    </button>
                    <button class="category-btn" data-category="hearts">
                        <i class="fas fa-heart"></i>
                    </button>
                    <button class="category-btn" data-category="symbols">
                        <i class="fas fa-star"></i>
                    </button>
                    <button class="category-btn" data-category="hands">
                        <i class="fas fa-thumbs-up"></i>
                    </button>
                </div>
                <button class="close-picker" id="closePicker">
                    <i class="fas fa-times"></i>
                </button>
            </div>


        </div>
    </div>
</div>


<script>
const equipoId = {{ equipo_id }};

// Cargar mensajes al iniciar
document.addEventListener('DOMContentLoaded', function() {
    cargarMensajes();
    // Recargar cada 3 segundos
    setInterval(cargarMensajes, 3000);
});

// Enviar mensaje
document.getElementById('messageForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const messageInput = document.getElementById('messageInput');
    const message = messageInput.value.trim();
    
    if (!message) return;
    
    // Mostrar loading en el botón
    const sendBtn = document.getElementById('sendBtn');
    const originalHTML = sendBtn.innerHTML;
    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    sendBtn.disabled = true;
    
    // Enviar mensaje con form-data (lo que tu servidor espera)
    const formData = new URLSearchParams();
    formData.append('mensaje', message);
    
    fetch(`/equipo/chat/enviar/${equipoId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            messageInput.value = '';
            cargarMensajes(); // Recargar mensajes inmediatamente
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error al enviar mensaje');
    })
    .finally(() => {
        // Restaurar botón
        sendBtn.innerHTML = originalHTML;
        sendBtn.disabled = false;
    });
});

// Cargar mensajes
function cargarMensajes() {
    fetch(`/equipo/chat/mensajes/${equipoId}`)
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            actualizarMensajes(data.mensajes);
        }
    })
    .catch(error => {
        console.error('Error cargando mensajes:', error);
    });
}

// Actualizar la interfaz con mensajes nuevos
function actualizarMensajes(mensajes) {
    const chatMessages = document.getElementById('chatMessages');
    
    if (!mensajes || mensajes.length === 0) {
        return;
    }
    
    // Obtener IDs de mensajes actuales
    const currentIds = new Set();
    chatMessages.querySelectorAll('.message').forEach(msg => {
        const id = msg.getAttribute('data-message-id');
        if (id) currentIds.add(parseInt(id));
    });
    
    // Agregar solo mensajes nuevos
    mensajes.forEach(mensaje => {
        if (!currentIds.has(mensaje.id)) {
            const messageElement = crearMensajeHTML(mensaje);
            chatMessages.appendChild(messageElement);
        }
    });
    
    // Scroll al final
    scrollToBottom();
}

// Crear HTML para un mensaje
function crearMensajeHTML(mensaje) {
    const isOwnMessage = mensaje.usuario_id === {{ usuario.id }};
    const messageDiv = document.createElement('div');
    
    messageDiv.className = `message ${isOwnMessage ? 'message-sent' : 'message-received'}`;
    messageDiv.setAttribute('data-message-id', mensaje.id);
    
    let hora = mensaje.fecha || '--:--';
    
    const nombreCompleto = mensaje.nombre_completo || 'Usuario';
    const avatarText = nombreCompleto.charAt(0).toUpperCase();

    messageDiv.innerHTML = `
        ${!isOwnMessage ? `
            <div class="message-avatar">
                <div class="avatar-circle">
                    ${avatarText}
                </div>
            </div>
        ` : ''}
        
        <div class="message-content">
            ${!isOwnMessage ? `
                <div class="message-header">
                    <span class="sender-name">${nombreCompleto}</span>
                    <span class="message-time">${hora}</span>
                </div>
            ` : ''}
            
            <div class="message-bubble">
                <div class="message-text">${mensaje.mensaje}</div>
                ${isOwnMessage ? `
                    <div class="message-status">
                        <span class="message-time">${hora}</span>
                        <i class="fas fa-check-double delivered"></i>
                    </div>
                ` : ''}
            </div>
        </div>
    `;

    return messageDiv;
}

// Scroll al final del chat
function scrollToBottom() {
    const chatMessages = document.getElementById('chatMessages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
}

// Contador de caracteres (opcional, pero útil)
document.getElementById('messageInput').addEventListener('input', function() {
    const count = this.value.length;
    const charCount = document.querySelector('.char-count');
    if (charCount) {
        charCount.textContent = count;
    }
    
    const sendBtn = document.getElementById('sendBtn');
    sendBtn.disabled = count === 0 || count > 1000;
});

// Enviar con Enter
document.getElementById('messageInput').addEventListener('keydown', function(e) {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        document.getElementById('messageForm').dispatchEvent(new Event('submit'));
    }
});
</script>
{% endblock %}